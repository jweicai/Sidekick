# ✅ 许可证系统集成完成

## 📋 已完成的工作

### 1. 核心文件
- ✅ `Sources/Services/License/MachineID.swift` - 机器码生成
- ✅ `Sources/Services/License/LicenseManager.swift` - 许可证管理
- ✅ `Sources/Views/ActivationView.swift` - 激活界面
- ✅ `Sources/App/SidekickApp.swift` - 主应用集成
- ✅ `Sources/Views/MainView.swift` - 设置页面集成

### 2. 工具脚本
- ✅ `generate_license.swift` - 激活码生成工具
- ✅ `test_license.sh` - 测试脚本

### 3. 文档
- ✅ `docs/许可证系统说明.md` - 完整使用文档
- ✅ `docs/许可证集成完成.md` - 本文档

## 🎯 功能特性

### 用户端功能
1. **90天试用期**
   - 首次启动自动开始试用
   - 实时显示剩余天数
   - 菜单栏显示试用状态

2. **试用期过期**
   - 功能完全锁定
   - 显示全屏遮罩
   - 引导用户激活

3. **激活界面**
   - 美观的 SwiftUI 界面
   - 邮箱 + 激活码输入
   - 实时验证反馈
   - 显示机器码

4. **设置页面**
   - 显示许可证状态
   - 显示剩余天数
   - 一键激活按钮
   - 机器码复制功能

### 开发者端功能
1. **激活码生成**
   ```bash
   swift generate_license.swift user@email.com MACHINE-ID
   ```

2. **本地验证**
   - 无需服务器
   - 离线可用
   - 机器码绑定

## 🚀 如何测试

### 1. 生成测试激活码

```bash
# 运行测试脚本
./test_license.sh

# 或手动生成
swift generate_license.swift test@example.com YOUR-MACHINE-ID
```

### 2. 测试流程

**首次启动：**
1. 构建并运行应用
2. 应该看到菜单栏显示"试用期剩余 90 天"
3. 打开设置 → 许可证，查看试用期信息

**测试激活：**
1. 点击"激活"按钮
2. 输入测试邮箱和激活码
3. 点击"激活"
4. 应该显示"激活成功"

**测试过期：**
1. 运行命令模拟过期：
   ```bash
   defaults write com.yourcompany.Sidekick Sidekick.TrialStart -date "$(date -v-91d)"
   ```
2. 重启应用
3. 应该看到全屏遮罩，功能被锁定

**测试激活后恢复：**
1. 在过期状态下点击"激活许可证"
2. 输入激活码
3. 激活成功后，遮罩消失，功能恢复

### 3. 清除测试数据

```bash
# 清除许可证数据
defaults delete com.yourcompany.Sidekick Sidekick.License

# 清除试用期数据
defaults delete com.yourcompany.Sidekick Sidekick.TrialStart
```

## 📱 用户界面

### 1. 主应用
- 试用期内：正常使用，菜单栏显示剩余天数
- 试用期过期：显示全屏遮罩，引导激活

### 2. 激活界面
- 邮箱输入框
- 激活码输入框（XXXX-XXXX-XXXX-XXXX 格式）
- 机器码显示和复制
- 购买链接
- 实时验证反馈

### 3. 设置页面
- 许可证状态（试用中/已激活/已过期）
- 剩余天数或激活信息
- 机器码显示和复制
- 激活按钮

## 🔧 配置说明

### 1. 修改试用期天数

在 `LicenseManager.swift` 中修改：

```swift
private let trialDays = 90  // 改为你想要的天数
```

### 2. 修改购买链接

在以下文件中搜索并替换 `https://your-store.com/sidekick`：
- `Sources/App/SidekickApp.swift`
- `Sources/Views/ActivationView.swift`

### 3. 修改 Bundle Identifier

在 Xcode 中修改 Bundle Identifier，确保与 UserDefaults 的 key 匹配。

当前使用的 key 前缀：`Sidekick.`

如果需要修改，在 `LicenseManager.swift` 中更新：
```swift
private let licenseKey = "YourApp.License"
private let trialStartKey = "YourApp.TrialStart"
```

## 📊 数据存储

### UserDefaults Keys
- `Sidekick.License` - 许可证信息（JSON）
- `Sidekick.TrialStart` - 试用开始时间（Date）

### 存储的许可证信息
```json
{
  "key": "XXXX-XXXX-XXXX-XXXX",
  "email": "user@email.com",
  "machineID": "12345678-1234-1234-1234-123456789ABC",
  "activatedAt": "2025-01-14T10:00:00Z"
}
```

## 🔐 安全性

### 1. 机器码绑定
- 基于硬件 UUID
- 重装系统不变
- 无法在其他设备使用

### 2. 本地验证
- 激活码 = SHA256(email + machineID + SECRET).前16位
- 验证在本地完成
- 无需联网

### 3. 防篡改
- 许可证信息存储在 UserDefaults
- 机器码验证确保无法迁移
- 激活码签名验证

## ⚠️ 注意事项

### 1. 密钥管理
- `SIDEKICK_SECRET` 是生成激活码的密钥
- 在 `LicenseManager.swift` 和 `generate_license.swift` 中保持一致
- 发布前修改为随机字符串
- 不要泄露到公开仓库

### 2. Bundle Identifier
- 确保 Xcode 项目的 Bundle Identifier 已设置
- UserDefaults 会使用 Bundle Identifier 作为域

### 3. 测试
- 发布前充分测试所有场景
- 测试不同的机器码
- 测试激活码验证逻辑

## 🎉 下一步

### 1. 立即可做
- [x] 测试试用期功能
- [x] 测试激活功能
- [x] 测试过期提示
- [ ] 修改购买链接
- [ ] 修改密钥
- [ ] 设置 Bundle Identifier

### 2. 发布前
- [ ] 完整测试所有场景
- [ ] 准备购买页面
- [ ] 准备激活码发送流程
- [ ] 准备用户文档

### 3. 发布后
- [ ] 监控激活情况
- [ ] 收集用户反馈
- [ ] 优化激活流程

## 📞 技术支持

如有问题，请查看：
- `docs/许可证系统说明.md` - 详细文档
- `test_license.sh` - 测试脚本
- `generate_license.swift` - 激活码生成工具

---

**集成完成时间：2025-01-14**
**版本：1.0.0**
**状态：✅ 可以开始测试**
