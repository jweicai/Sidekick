# 数据管理架构

## 概述

Sidekick 采用分层架构管理数据，确保系统健壮性和良好的用户体验。

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户操作                                 │
│   导入文件 / 粘贴数据 / 删除表 / 执行查询                         │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                    MainViewModel (UI 层)                        │
│  - 管理表的元数据和 UI 状态                                      │
│  - 协调文件加载                                                  │
│  - 持久化元数据到 UserDefaults                                   │
│  - 持久化数据到 Parquet/JSON 文件                                │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                   QueryViewModel (查询层)                        │
│  - 注册表到 DuckDB                                              │
│  - 执行 SQL 查询                                                │
│  - 管理查询历史                                                  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                   DuckDBEngine (存储引擎)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 内存数据库   │  │ 小表缓存     │  │ 大表文件映射 │             │
│  │ (DuckDB)    │  │ (DataFrame) │  │ (文件路径)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────────┐
│                        持久化存储                                │
│  ~/Library/Application Support/Sidekick/Tables/                 │
│  ├── table1.parquet    (小表数据，ZSTD压缩)                      │
│  ├── table2.parquet                                             │
│  ├── table3.csv        (大表临时文件)                            │
│  └── table3.parquet    (大表最终文件，后台转换)                   │
│                                                                 │
│  UserDefaults:                                                  │
│  └── Sidekick.LoadedTables: [表元数据JSON]                      │
└─────────────────────────────────────────────────────────────────┘
```

## 各层职责

### MainViewModel (UI 层)

**文件**: `Sources/ViewModels/MainViewModel.swift`

职责：
- 管理 `loadedTables` 数组（表的元数据和状态）
- 处理文件导入和剪贴板粘贴
- 管理表的选中状态
- 持久化表元数据到 UserDefaults
- 持久化表数据到 Parquet 文件

不负责：
- 直接操作 DuckDB
- SQL 查询执行

### QueryViewModel (查询层)

**文件**: `Sources/ViewModels/QueryViewModel.swift`

职责：
- 将表数据注册到 DuckDB
- 执行 SQL 查询
- 管理查询历史
- SQL 格式化

### DuckDBEngine (存储引擎)

**文件**: `Sources/Services/SQLEngine/DuckDBEngine.swift`

职责：
- 管理 DuckDB 内存数据库连接
- 小表（<10万行）：导入内存，缓存 DataFrame 用于恢复
- 大表（>=10万行）：创建视图指向文件，不占用内存
- 数据库崩溃时自动恢复所有表
- Parquet 文件读写

## 表状态流转

```
    ┌──────────┐
    │  初始化   │
    └────┬─────┘
         │ 开始加载
         ▼
    ┌──────────┐     加载成功      ┌──────────┐
    │ loading  │ ───────────────▶ │  ready   │
    └────┬─────┘                  └────┬─────┘
         │                             │
         │ 加载失败                     │ 查询失败(DuckDB崩溃)
         ▼                             ▼
    ┌──────────┐                  ┌──────────┐
    │  error   │                  │ 自动恢复  │
    └──────────┘                  └────┬─────┘
                                       │ 恢复成功
                                       ▼
                                  ┌──────────┐
                                  │  ready   │
                                  └──────────┘
```

## 错误处理策略

| 场景 | 处理方式 | 用户感知 |
|------|---------|---------|
| 文件解析失败 | 表标记为 error，不影响其他表 | 表显示红色错误图标 |
| DuckDB 插入失败 | 表标记为 error，记录错误原因 | 表显示错误信息 |
| 查询时 DuckDB 崩溃 | 自动重启，恢复所有表，重试查询 | 用户无感知（或短暂延迟） |
| 持久化失败 | 回退到 JSON 格式 | 用户无感知 |
| 启动时加载失败 | 异步加载，失败的表标记 error | 正常表可用，错误表显示状态 |

## 大表处理流程

对于行数 >= 10万 的表：

1. **导入时**：
   - 将数据写入 CSV 文件（快速）
   - 创建 DuckDB 视图指向 CSV 文件
   - 后台异步将 CSV 转换为 Parquet（ZSTD 压缩）
   - 转换完成后切换视图到 Parquet，删除 CSV

2. **查询时**：
   - DuckDB 直接查询文件，不加载到内存
   - 利用 Parquet 的列式存储优化查询性能

3. **恢复时**：
   - 如果已有 Parquet 文件，直接创建视图
   - 否则重新从 CSV 创建视图

## 持久化格式

### 表元数据 (UserDefaults)

```json
[
  {
    "name": "table1",
    "displayName": "users",
    "sourceURLPath": "/path/to/users.csv"
  }
]
```

### 表数据

优先使用 Parquet 格式（ZSTD 压缩），失败时回退到 JSON：

**Parquet**: 二进制列式存储，高压缩比，查询高效

**JSON 回退格式**:
```json
{
  "columns": [
    {"name": "id", "type": "integer"},
    {"name": "name", "type": "text"}
  ],
  "rows": [
    ["1", "Alice"],
    ["2", "Bob"]
  ]
}
```

## 关键设计决策

1. **异步启动加载** - 持久化表在后台线程加载，不阻塞 UI 启动

2. **独立错误处理** - 每个表独立处理错误，一个表失败不影响其他表

3. **自动恢复机制** - DuckDB 崩溃后自动重启并恢复所有表，对用户透明

4. **大表文件查询** - 大表不加载到内存，直接查询文件，节省内存

5. **DataFrame 缓存** - 小表的 DataFrame 缓存在内存中，用于数据库恢复

6. **渐进式持久化** - 大表先保存为 CSV（快），后台转 Parquet（优化）

## 日志模块

所有数据操作都有详细日志，便于问题排查：

- `[Database]` - DuckDB 操作
- `[Persistence]` - 持久化操作
- `[Query]` - SQL 查询
- `[FileLoader]` - 文件加载

日志文件位置: `~/Library/Logs/Sidekick/`
